---
title: "R Notebook"
output: html_notebook
---

### TODO   

1. Apply outlier detection criteria and then calculate the MFI intensities?  

```{r}
library(tidyverse)
library(tolerance)
library(nls.multstart)
freenome_colors <- c('#948DFF', '#1DE3FE', '#BBD532', '#FF9D42',  '#FC2E7B', 
                   '#FECDD1')
```


```{r}
panel_1 <- readxl::read_xlsx(here::here("data", "reproducibility-study", "raw", 
                             "betalot_reproducibility_dataframes.xlsx"), 
                  sheet = 1) %>% 
  janitor::clean_names()

panel_2 <- readxl::read_xlsx(here::here("data", "reproducibility-study", "raw", 
                             "betalot_reproducibility_dataframes.xlsx"), 
                  sheet = 2) %>% 
  janitor::clean_names()

combined <- bind_rows(panel_1, panel_2)
```


**We will only choose plates/data that didn't bead loss on the standards**     


```{r}
panel_1 %>%  
  filter(sample_type == "standard") %>% 
  ggplot(.,aes(xponent_id, bead_count)) + 
  geom_point() + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

panel_2 %>%  
  filter(sample_type == "standard") %>% 
  ggplot(.,aes(xponent_id, bead_count)) + 
  geom_point() + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



############### Outlier Detection Method on all 24 replicates ################## 

calc_mod_z <- function(vec) {
  vec_median <- median(vec) 
  vec_mad <- mad(vec) 
  
  mod_z <- 0.6745*(vec - vec_median)/vec_mad 
  return(mod_z)
}

panel_1 %>% 
  filter(sample_type == "standard") %>% 
  group_by(xponent_id, assay, plate_number) %>% 
  select(median_mfi) %>% 
  summarise(mad_z = calc_mod_z(median_mfi)) %>% 
  ggplot(.,aes(mad_z)) + 
  geom_histogram()
  

panel_2 %>% 
  filter(sample_type == "standard") %>% 
  group_by(xponent_id, assay, plate_number) %>% 
  select(median_mfi) %>% 
  summarise(mad_z = calc_mod_z(median_mfi)) %>% 
  ggplot(.,aes(mad_z)) + 
  geom_histogram()
```


**Filter out modified z_scores that are > 3.5**   

```{r}
panel_1_rm <- panel_1 %>% 
  group_by(xponent_id, assay, plate_number) %>% 
  #select(median_mfi) %>% 
  mutate(mad_z = calc_mod_z(median_mfi)) %>% 
  ungroup() %>% 
  filter(abs(mad_z) < 3.5)

panel_2_rm <- panel_2 %>% 
  group_by(xponent_id, assay, plate_number) %>% 
  #select(median_mfi) %>% 
  mutate(mad_z = calc_mod_z(median_mfi)) %>% 
  ungroup() %>% 
  filter(abs(mad_z) < 3.5)

combined <- bind_rows(panel_1_rm, panel_2_rm, .id = "panel")
```







### Reference standard concentrations  

We also need a column that indicates the concentration using all 24 replicates of the plate (currently, luminex only calculates the conc for 8 replicates) 

```{r}
logistic_5pl <- function(d, a, median_mfi, c, b, g) {
  return(d + (a-d)/(a + (median_mfi/c)^b)^g)
}

fit_5pl <- function(df = NULL){
  nls.multstart::nls_multstart(standard_expected_concentration ~ 
                                          logistic_5pl(d, a, median_mfi = median_mfi, 
                                                       c, b, g), 
                                        data = df, 
                                        iter = 100000, 
                                        modelweights = 1/standard_expected_concentration^2,
                                        start_lower = c(a = -1, b = -1, c = 100, d = -1, 
                                                        g = -1), 
                                        start_upper = c(a = 1, b = 1, c = 200, d = 1, 
                                                        g = 1), 
                                        supp_errors = "Y", 
                                        control = nls.control(maxiter = 100000, 
                                                              minFactor=1e-7, 
                                                              tol=1e-5, 
                                                              printEval=F, 
                                                              warnOnly=F))
}

############### Standard Curves ################
calc_nls_conc <- function(protein = "NULL") {
  df_mod <- combined %>% 
    filter(sample_type == "standard") %>% 
    filter(assay == protein)
  
  fit_mod <- fit_5pl(df = df_mod) 
  df_mod <- broom::augment(fit_mod, df_mod) %>% 
    rename(nls_conc = .fitted)
  return(df_mod)
} 

list_of_proteins <- combined %>% select(assay) %>% 
  distinct() %>% 
  pull()

new_combined <- map_dfr(list_of_proteins, ~ calc_nls_conc(protein = .x))

new_combined <- new_combined %>% 
  mutate(nls_recov = 100*nls_conc/standard_expected_concentration)

new_combined %>% 
  ggplot(.,aes(log(nls_conc + 1), log(calc_conc + 1))) + 
  geom_point() + 
  facet_grid(rows = vars(plate_number), cols = vars(panel)) + 
  theme_classic() + 
  labs(title = "Comparing R fit vs xPonent Fit")
```





### Tolerance Intervals   

We will develop tolerance intervals using guidance from  



**Median MFI tolerance intervals for standards**   
```{r}
tolerance_intervals_mfi <- function(std = "NULL", protein = "NULL", df = NULL){
  df %>% 
    filter(assay == protein) %>% 
    filter(xponent_id == paste0("Standard", std)) %>% 
    pull(median_mfi) %>% 
    tolerance::normtol.int(., method = "EXACT", side = 2, m = 500, 
                           log.norm = FALSE, P = 0.95) %>% 
    janitor::clean_names() %>% 
    mutate(assay = protein, xponent_id = paste0("Standard", std)) %>% 
    return()

}

tol_stds <- function(std = "NULL") {
  map_dfr(list_of_proteins, ~ tolerance_intervals_mfi(std = std, protein = .x, df = combined))
}


list_of_proteins <- combined %>% select(assay) %>% pull() %>% unique()

tol_stds_df <- map_dfr(c("1", "2", "3", "4", "5", "6"), ~ tol_stds(std = .x))

tol_stds_df <- combined %>% 
  select(assay, panel) %>% 
  distinct(assay, .keep_all = TRUE) %>% 
  right_join(tol_stds_df)
  
```


```{r}
tol_stds_plot <- function(df = NULL, std = "NULL"){
  
}

tol_stds_df %>% 
  filter(xponent_id == "Standard1") %>% 
  ggplot(.,aes(assay, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1]) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for Standard 1", 
       y = "MFI") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

tol_stds_df %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1]) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for Standard 1", 
       y = "MFI") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) + 
  scale_y_log10()

tol_stds_df %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1]) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits", 
       y = "MFI") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) 


### panel 1 ### 

tol_stds_df %>% 
  filter(panel == "1") %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.5, size = 0.8) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits", subtitle = "Panel 1", 
       y = "MFI") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) + 
  scale_y_log10() 

### panel 2 ### 

tol_stds_df %>% 
  filter(panel == "2") %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.25, size = 0.8) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits", subtitle = "Panel 2", 
       y = "MFI") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) + 
  scale_y_log10()
```

```{r}
write_csv(tol_stds_df, here::here("data", "processed", "tolerance-intervals", 
                                  paste0("Standards-MFI-tolerances", Sys.Date(), ".csv")))
```





**Recoveries**   

```{r}
new_combined <- new_combined %>% 
  mutate(xponent_recovery = 100*(calc_conc/standard_expected_concentration))
```


```{r}
tolerance_intervals_recovery <- function(std = "NULL", protein = "NULL", df = NULL){
  df %>% 
    filter(assay == protein) %>% 
    filter(xponent_id == paste0("Standard", std)) %>% 
    pull(nls_recov) %>% 
    tolerance::normtol.int(., method = "EXACT", side = 2, m = 500, 
                           log.norm = FALSE, P = 0.95) %>% 
    janitor::clean_names() %>% 
    mutate(assay = protein, xponent_id = paste0("Standard", std)) %>% 
    return()

}

tol_recovery_iterate <- function(std = "NULL") {
  map_dfr(list_of_proteins, ~ tolerance_intervals_recovery(std = std, protein = .x, 
                                                           df = new_combined))
}


list_of_proteins <- new_combined %>% select(assay) %>% pull() %>% unique()

tol_recovery_df <- map_dfr(c("1", "2", "3", "4", "5", "6"), ~ 
                             tol_recovery_iterate(std = .x))

tol_recovery_df <- combined %>% 
  select(assay, panel) %>% 
  distinct(assay, .keep_all = TRUE) %>% 
  right_join(tol_recovery_df)

```

```{r}
tol_recovery_df %>% 
  filter(panel == "1") %>%
  mutate(x2_sided_lower = ifelse(x2_sided_lower < 0, 0, x2_sided_lower)) %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_point(color = freenome_colors[1], size = 0.75) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.25) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for Recovery", subtitle = "Panel 1", 
       y = "% Recovery", caption = "Horizontal Lines are 70-130") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) +
  scale_y_continuous(breaks = seq(0, 250, by = 40)) + 
  geom_hline(yintercept = c(70, 130))

tol_recovery_df %>% 
  filter(panel == "2") %>%
  mutate(x2_sided_lower = ifelse(x2_sided_lower < 0, 0, x2_sided_lower)) %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_point(color = freenome_colors[1], size = 0.75) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.25) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for Recovery", subtitle = "Panel 2", 
       y = "% Recovery", caption = "Horizontal Lines are 70-130") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) +
  scale_y_continuous(breaks = seq(0, 250, by = 40)) + 
  geom_hline(yintercept = c(70, 130))
```


```{r}
tol_recovery_df %>% 
  write_csv(., here::here("data", "processed", "tolerance-intervals", 
                                  paste0("Standards-Recoveries-tolerances", Sys.Date(), ".csv")))
```


**Tolerance for Concentration CVs**    


```{r}
tolerance_intervals_cv <- function(std = "NULL", protein = "NULL", df = NULL){
  df %>% 
    filter(assay == protein) %>% 
    filter(xponent_id == paste0("Standard", std)) %>% 
    group_by(xponent_id, plate_number) %>% 
    summarise(conc_pct_cv_nls = 100*sd(nls_conc)/mean(nls_conc)) %>% 
    ungroup() %>% 
    pull(conc_pct_cv_nls) %>% 
    tolerance::normtol.int(., method = "EXACT", side = 2, m = 500, 
                           log.norm = FALSE, P = 0.95) %>% 
    janitor::clean_names() %>% 
    mutate(assay = protein, xponent_id = paste0("Standard", std)) %>% 
    return()

}

tol_recovery_iterate <- function(std = "NULL") {
  map_dfr(list_of_proteins, ~ tolerance_intervals_cv(std = std, protein = .x, 
                                                           df = new_combined))
}

list_of_proteins <- combined %>% select(assay) %>% pull() %>% unique()

tol_cv_df <- map_dfr(c("1", "2", "3", "4", "5", "6"), ~ 
                             tol_recovery_iterate(std = .x))

tol_cv_df <- combined %>% 
  select(assay, panel) %>% 
  distinct(assay, .keep_all = TRUE) %>% 
  right_join(tol_cv_df)
```



```{r}
tol_cv_df %>% 
  filter(panel == "1") %>%
  mutate(x2_sided_lower = ifelse(x2_sided_lower < 0, 0, x2_sided_lower)) %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.25) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for CV", subtitle = "Panel 1", 
       y = "% CV", caption = "") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) +
  scale_y_continuous(breaks = seq(0, 250, by = 40)) 

tol_cv_df %>% 
  filter(panel == "2") %>%
  mutate(x2_sided_lower = ifelse(x2_sided_lower < 0, 0, x2_sided_lower)) %>% 
  ggplot(.,aes(xponent_id, x_bar)) + 
  geom_errorbar(aes(ymin = x2_sided_lower, ymax = x2_sided_upper), 
                color = freenome_colors[1], width = 0.25) + 
  theme_classic() + 
  labs(title = "95 % Tolerance Limits for CV", subtitle = "Panel 2", 
       y = "% CV", caption = "") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  facet_wrap(vars(assay)) +
  scale_y_continuous(breaks = seq(0, 250, by = 40)) 
```














