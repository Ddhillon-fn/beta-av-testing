---
title: "Untitled"
output: html_document
---


### Introduction  

This notebook imports data from the experiment where the standards for both protein panels have been run across different plates 

Rashmi has aggregated all the data into an excel file - sheet 1 is panel 1 and sheet 2 is panel 2. The plate layout is on panel 3. 


```{r}
library(tidyverse)

freenome_colors <- c('#948DFF', '#1DE3FE', '#BBD532', '#FF9D42',  '#FC2E7B', 
                   '#FECDD1')
```

```{r}
panel_1 <- readxl::read_xlsx(here::here("data", "reproducibility-study", "raw", 
                             "betalot_reproducibility_dataframes.xlsx"), 
                  sheet = 1) %>% 
  janitor::clean_names()

panel_2 <- readxl::read_xlsx(here::here("data", "reproducibility-study", "raw", 
                             "betalot_reproducibility_dataframes.xlsx"), 
                  sheet = 2) %>% 
  janitor::clean_names()

```

```{r}
skimr::skim(panel_1)
```



```{r}
dplyr::glimpse(panel_1)
```




```{r}
panel_1 %>% 
  distinct(xponent_id)
```



### Bead counts   

```{r fig.height=5, fig.width=8}
panel_1 %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 1 Bead Count Distribution")

panel_2 %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 2 Bead Count Distribution")



### Bead counts for only the standards   
panel_1 %>% 
  filter(sample_type == "standard") %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 1 Bead Count Distribution")

panel_2 %>% 
  filter(sample_type == "standard") %>%
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 2 Bead Count Distribution")



### Bead Counts for only RCs  
panel_1 %>% 
  filter(sample_type == "sample") %>% 
  filter(grepl("C", xponent_id)) %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 1 Bead Count Distribution")

panel_2 %>% 
  filter(sample_type == "sample") %>% 
  filter(grepl("C", xponent_id)) %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 2 Bead Count Distribution")



### Bead Counts for only assay buffer and background  
panel_1 %>% 
  filter(sample_type == "sample") %>% 
  filter(grepl("Buffer", xponent_id)) %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 1 Bead Count Distribution")

panel_2 %>% 
  filter(sample_type == "sample") %>% 
  filter(grepl("Buffer", xponent_id)) %>% 
  ggplot(., aes(assay, bead_count)) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  geom_hline(yintercept = 35) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15)) + 
  labs(title = "Panel 2 Bead Count Distribution")

```

```{r}
## number of wells with beads < 35 in each plate ? 
panel_1 %>% 
  mutate(bead_count_fail = if_else(bead_count < 35, "fail", "pass")) %>% 
  group_by(assay, plate_number) %>% 
  count(bead_count_fail) %>% 
  filter(bead_count_fail == "fail") %>% 
  ggplot(., aes(assay,n)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Number of wells failing bead count (Panel 1)") 


panel_2 %>% 
  mutate(bead_count_fail = if_else(bead_count < 35, "fail", "pass")) %>% 
  group_by(assay, plate_number) %>% 
  count(bead_count_fail) %>% 
  filter(bead_count_fail == "fail") %>% 
  ggplot(., aes(assay,n)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Number of wells failing bead count (Panel 2)") 


```


```{r}
### by row or column? 
panel_1 %>% 
  mutate(bead_count_fail = if_else(bead_count < 35, "fail", "pass")) %>% 
  group_by(assay, plate_number, well_row) %>% 
  count(bead_count_fail) %>% 
  filter(bead_count_fail == "fail") %>% 
  mutate(prop = n/24) %>% 
  ggplot(., aes(assay,prop)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number), rows = vars(well_row)) + 
  #theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Proportion wells failing bead count (Panel 1)", 
       subtitle = "By Row") 

panel_2 %>% 
  mutate(bead_count_fail = if_else(bead_count < 35, "fail", "pass")) %>% 
  group_by(assay, plate_number, well_row) %>% 
  count(bead_count_fail) %>% 
  filter(bead_count_fail == "fail") %>% 
  mutate(prop = n/24) %>% 
  ggplot(., aes(assay,prop)) +  
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number), rows = vars(well_row)) + 
  theme(axis.text.y = element_text(angle = 45, vjust = 1)) + 
  #theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Proportion wells failing bead count (Panel 2)", 
       subtitle = "By Row") 

```




### Intra CVs  

**CVs listed within the data**  
```{r}
##### Using pre calculated CVs 
panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  ggplot(.,aes(assay, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 1)") 

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  ggplot(.,aes(assay, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)") 
```


CVs calculated here - why are they different from Rashmis? 

**CVs calculated ourself here**   
```{r}
##### Calculate CVs myself   
panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 1)") 

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)") 
```

**RC CVs**  

```{r}
panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type != "standard") %>% 
  #group_by(plate_number, assay, xponent_id) %>% 
  #summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(assay, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 1)", 
       subtitle = "RC") 

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type != "standard") %>% 
  #group_by(plate_number, assay, xponent_id) %>% 
  #summarise(intra_cv = 100*(sd(median_mfi)/mean(median))) %>% 
  ggplot(.,aes(assay, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)", 
       subtitle = "RC") 



panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type != "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(median_mfi)/mean(median_mfi))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)", 
       subtitle = "RC MFI") 

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type != "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(median_mfi)/mean(median_mfi))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)", 
       subtitle = "RC MFI") 
```

**Are some of the high CV proteins under the det limit?**   

```{r}
panel_1 %>% 
  filter(assay == "IL-6") %>% 
  filter(grepl("RC", xponent_id)) %>% 
  #filter(xponent_id == "RC2") %>% 
  group_by(plate_number, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) 


panel_1 %>% 
  filter(grepl("RC", xponent_id)) %>%
  filter(conc_pct_cv > 15) %>% 
  filter(calc_conc < 20) %>% 
  ggplot(.,aes(calc_conc, calc_conc_standards_min)) + 
  geom_point(color = freenome_colors[1]) + 
  scale_y_continuous(breaks = seq(0, 16, by = 2)) 
```









*Why are the CVs we calculated here different from the CVs in PATE?*  
It's because xPonent only allows max 8 reps - rashmi then manually combined all the data  



**Column Effect?**  
Which proteins have the highest  std CVs?  


```{r}
panel_1 %>% 
  filter(sample_type == "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 1)", 
       subtitle = "Only Standards") + 
  geom_hline(yintercept = 10, color = freenome_colors[1])

panel_2 %>% 
  filter(sample_type == "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(assay, intra_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  geom_boxplot(outlier.shape = NA, color = freenome_colors[1]) + 
  facet_wrap(vars(plate_number)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  labs(title = "Distribution of Intra CVs (Panel 2)", 
       subtitle = "Only Standards") + 
  geom_hline(yintercept = 10, color = freenome_colors[1])




panel_1 %>% 
  filter(sample_type == "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(xponent_id, intra_cv)) + 
  geom_point(color = freenome_colors[1], aes(shape = plate_number)) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  geom_hline(yintercept = 15, color = freenome_colors[1]) + 
  labs(title = "Intra CVs", 
       subtitle = "For each plate")

panel_2 %>% 
  filter(sample_type == "standard") %>% 
  group_by(plate_number, assay, xponent_id) %>% 
  summarise(intra_cv = 100*(sd(calc_conc)/mean(calc_conc))) %>% 
  ggplot(.,aes(xponent_id, intra_cv)) + 
  geom_point(color = freenome_colors[1], aes(shape = plate_number)) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  geom_hline(yintercept = 15, color = freenome_colors[1])
```






```{r}
### MIF has a higher CV consistently 
### Why? 

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(assay == "MIF") %>% 
  ggplot(.,aes(well_row, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  theme_classic() + 
  facet_wrap(vars(plate_number)) + 
  labs(title = "MIF Intra CVs vs Well Row", 
       subtitle = "")

panel_2 %>% 
  filter(assay == "MIF") %>% 
  mutate(sample_type = ifelse(xponent_id == "Assay Buffer", "assay_buffer", sample_type)) %>% 
  filter(xponent_id != "Background0") %>% 
  ggplot(.,aes(well_row, conc_pct_cv)) + 
  geom_point(aes(color = sample_type), size = 2) + 
  theme_classic() + 
  facet_wrap(vars(plate_number)) + 
  labs(title = "MIF Intra CVs vs Well Row", 
       subtitle = "") + 
  scale_color_manual(values = freenome_colors[1:3])
  


```

**Any relationship between average bead count and CV?**    


```{r}
panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  group_by(assay, plate_number, xponent_id) %>% 
  summarise(avg_bead_count = mean(bead_count), conc_pct_cv = mean(conc_pct_cv)) %>% 
  ggplot(.,aes(avg_bead_count, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  labs(title = "Relationship between bead count and intra CV?", 
       subtitle = "") + 
  geom_vline(xintercept = 35, color = freenome_colors[1])

panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type != "standard") %>% 
  group_by(assay, plate_number, xponent_id) %>% 
  summarise(avg_bead_count = mean(bead_count), conc_pct_cv = mean(conc_pct_cv)) %>% 
  ggplot(.,aes(avg_bead_count, conc_pct_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  labs(title = "Relationship between bead count and intra CV?", 
       subtitle = "RC") + 
  geom_vline(xintercept = 35, color = freenome_colors[1])




```



### Plate effect   

**Inter CVs**   


```{r}
panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "standard") %>% 
  group_by(assay, xponent_id) %>% 
  summarise(mean_conc = mean(avg_conc), sd_conc = sd(avg_conc), 
            inter_cv = 100*(sd_conc/mean_conc)) %>% 
  ggplot(.,aes(xponent_id, inter_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Interplate CVs (Panel 1)")

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "standard") %>% 
  group_by(assay, xponent_id) %>% 
  summarise(mean_conc = mean(avg_conc), sd_conc = sd(avg_conc), 
            inter_cv = 100*(sd_conc/mean_conc)) %>% 
  ggplot(.,aes(xponent_id, inter_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Interplate CVs (Panel 2)")



panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "sample") %>% 
  group_by(assay, xponent_id) %>% 
  summarise(mean_conc = mean(avg_conc), sd_conc = sd(avg_conc), 
            inter_cv = 100*(sd_conc/mean_conc)) %>% 
  ggplot(.,aes(xponent_id, inter_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Interplate CVs (Panel 1)")

panel_2 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "sample") %>% 
  group_by(assay, xponent_id) %>% 
  summarise(mean_conc = mean(avg_conc), sd_conc = sd(avg_conc), 
            inter_cv = 100*(sd_conc/mean_conc)) %>% 
  ggplot(.,aes(xponent_id, inter_cv)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Interplate CVs (Panel 2)")
```


What is going on with CA15-3? 

```{r}
panel_1 %>% 
  filter(assay == "CA15-3") %>% 
  filter(sample_type == "standard") %>% 
  filter(xponent_id == "Standard1") %>% 
  ggplot(.,aes(plate_number, calc_conc)) + 
  geom_point()
```





```{r}
panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "standard") %>% 
  filter(grepl("L", assay)) %>% 
  ggplot(., aes(xponent_id, log(calc_conc))) + 
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number), rows = vars(assay))

panel_1 %>% 
  filter(sample_type != "background") %>% 
  filter(xponent_id != "Assay Buffer") %>% 
  filter(sample_type == "standard") %>% 
  filter(!grepl("L", assay)) %>% 
  ggplot(., aes(xponent_id, log(calc_conc))) + 
  geom_point(color = freenome_colors[1]) + 
  facet_grid(cols = vars(plate_number), rows = vars(assay))



```



## Limits on MFI  


Here we will start looking at some MFI values across plates and see if we can set some thresholds on the standards only  


```{r}
standards_panel_1 <- panel_1 %>% 
  filter(sample_type == "standard") 

standards_panel_2 <- panel_2 %>% 
  filter(sample_type == "standard")
```




```{r}
standards_panel_1 %>% 
  filter(xponent_id == "Standard1") %>% 
  ggplot(.,aes(plate_number, median_mfi)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme_classic() + 
  labs(title = "Standard 1", 
       subtitle = "Panel 1") 


### thought experiment  
tmp <- rstanarm::stan_lmer(log(median_mfi) ~ (1|plate_number) + assay + xponent_id, 
                           data = standards_panel_1) 


pp_check(tmp)

data.frame(plate_number = "Plate 1", 
           assay = "AFP", xponent_id = "Standard1") %>% 
  posterior_epred(tmp, newdata = ., transform = TRUE) %>% 
  data.frame() %>% 
  summarise(mean = mean(X1), upper = quantile(X1, 0.99), 
            lower = quantile(X1, 0.01)) 


standards_panel_1 %>% 
  filter(xponent_id == "Standard1") %>% 
  ggplot(.,aes(plate_number, median_mfi)) + 
  geom_point(color = freenome_colors[1]) + 
  facet_wrap(vars(assay)) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme_classic() + 
  labs(title = "Standard 1", 
       subtitle = "Panel 1") 
```

```{r}
tmp_int <- rstanarm::stan_lmer(log(median_mfi) ~ (1|plate_number) + assay + xponent_id + 
                                 assay:xponent_id, 
                           data = standards_panel_1, cores = 4) 

```


```{r}
pp_check(tmp_int)
```

```{r}
tidybayes::add_predicted_draws(newdata = data.frame( 
           assay = "AFP", xponent_id = "Standard1"), 
           tmp_int, re_formula = NA) %>% 
  summarise(upper = quantile(.prediction, 0.95), lower = quantile(.prediction, 0.05))


standards_panel_1 %>% 
  filter(assay == "AFP") %>% 
  filter(xponent_id == "Standard1") %>% 
  ggplot(., aes(log(median_mfi))) + 
  geom_density() + 
  geom_vline(xintercept = 10.94457) + 
  geom_vline(xintercept = 10.56115)
```


### AFP   


```{r}
afp <- standards_panel_1 %>% 
  filter(assay == "AFP")

afp_single <- afp %>% 
  mutate(median_mfi_scaled = scale(median_mfi))
```

```{r}
afp_mod <- brms::brm(median_mfi_scaled ~ (1|xponent_id) + (1|plate_number) + 
                       (1|xponent_id:plate_number), 
                     data = afp_single, 
                     prior = prior(student_t(3, 0, 1), class = "sd"), 
                     cores = 2, iter = 8000)
```

```{r}
tidybayes::add_predicted_draws(afp_mod, newdata = data.frame(xponent_id = 
                                                               c("Standard1", 
                                                                 "Standard2", 
                                                                 "Standard3", 
                                                                 "Standard4", 
                                                                 "Standard5", 
                                                                 "Standard6")), 
                               re_formula = ~ (1|xponent_id)) %>% 
  group_by(xponent_id) %>% 
  summarise(mean = mean(.prediction), 
            upper = quantile(.prediction, 0.99), 
            lower = quantile(.prediction, 0.01)) %>% 
  ggplot(.,aes(xponent_id, mean)) + 
  geom_point() + 
  tidybayes::geom_pointinterval(aes(ymin = lower, ymax = upper)) + 
  geom_point(data = afp_single, aes(xponent_id, median_mfi_scaled), color = freenome_colors[1])


tidybayes::add_predicted_draws(afp_mod, newdata = data.frame(xponent_id = 
                                                               c("Standard1", 
                                                                 "Standard2", 
                                                                 "Standard3", 
                                                                 "Standard4", 
                                                                 "Standard5", 
                                                                 "Standard6")), 
                               re_formula = ~ (1|xponent_id)) %>% 
  group_by(xponent_id) %>% 
  summarise(mean = mean(.prediction), 
            upper = quantile(.prediction, 0.99), 
            lower = quantile(.prediction, 0.01)) %>% 
  ggplot(.,aes(xponent_id, mean)) + 
  geom_point() + 
  tidybayes::geom_pointinterval(aes(ymin = lower, ymax = upper)) + 
  geom_point(data = afp_single, aes(xponent_id, median_mfi_scaled), color = freenome_colors[1])
```





















